<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool - Phirst Park Homes</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üöó Carpool Matcher</h1>
        <p>Find rideshares in your community</p>
    </header>

    <main>
        <!-- Post Ride Form Section -->
        <section id="post-ride-section">
            <h2>Post a Ride</h2>
            <form id="post-ride-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Your Name *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact_method">Contact Method *</label>
                        <select id="contact_method" name="contact_method" required>
                            <option value="">Choose...</option>
                            <option value="messenger">Messenger</option>
                            <option value="viber">Viber</option>
                            <option value="phone">Phone</option>
                            <option value="telegram">Telegram</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contact_info">Contact Info *</label>
                    <input type="text" id="contact_info" name="contact_info" 
                           placeholder="e.g., facebook.com/yourname or 0917-123-4567" required>
                </div>

                <div class="form-group">
                    <label for="post_type">I want to *</label>
                    <select id="post_type" name="post_type" required>
                        <option value="">Choose...</option>
                        <option value="offer">Offer a ride (I'm driving)</option>
                        <option value="request">Request a ride (I need a ride)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="origin">From *</label>
                        <select id="origin" name="origin" required>
                            <option value="">Choose origin...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">To *</label>
                        <select id="destination" name="destination" required>
                            <option value="">Choose destination...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <fieldset>
                        <legend>Days of Week *</legend>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="days" value="monday"> Monday</label>
                            <label><input type="checkbox" name="days" value="tuesday"> Tuesday</label>
                            <label><input type="checkbox" name="days" value="wednesday"> Wednesday</label>
                            <label><input type="checkbox" name="days" value="thursday"> Thursday</label>
                            <label><input type="checkbox" name="days" value="friday"> Friday</label>
                            <label><input type="checkbox" name="days" value="saturday"> Saturday</label>
                            <label><input type="checkbox" name="days" value="sunday"> Sunday</label>
                        </div>
                    </fieldset>
                </div>

                <div class="form-group">
                    <label for="departure_time">Departure Time (optional)</label>
                    <input type="time" id="departure_time" name="departure_time">
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes (optional)</label>
                    <textarea id="notes" name="notes" rows="3"
                              placeholder="Any other details..."></textarea>
                </div>

                <!-- Vehicle fields (shown only for offers) -->
                <div id="vehicle-fields" style="display:none;">
                    <div class="form-group">
                        <label for="vehicle_model">Vehicle Model (optional)</label>
                        <input type="text" id="vehicle_model" name="vehicle_model"
                               maxlength="100" placeholder="e.g., Toyota Vios, Honda City">
                    </div>

                    <div class="form-group">
                        <label for="available_seats">Available Seats (optional)</label>
                        <input type="number" id="available_seats" name="available_seats"
                               min="1" max="10" placeholder="How many passengers?">
                    </div>
                </div>

                <button type="submit" class="btn-submit">Post Ride</button>
                <div id="form-message"></div>
            </form>
        </section>

        <!-- Existing Rides List -->
        <section id="rides-list">
            <h2>Available Rides</h2>
            <div id="rides-container">
                <p class="loading">Loading rides...</p>
            </div>
        </section>
    </main>

    <script src="js/analytics.js"></script>
    <script>
        // XSS Protection - Escape user input before displaying
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Show vehicle fields only for offers
        document.getElementById('post_type').addEventListener('change', (e) => {
            const isOffer = e.target.value === 'offer';
            const vehicleFields = document.getElementById('vehicle-fields');
            if (vehicleFields) {
                    vehicleFields.style.display = isOffer ? 'block' : 'none';
            }
        });

        // Load locations into dropdowns
        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const locations = await response.json();
                
                const originSelect = document.getElementById('origin');
                const destSelect = document.getElementById('destination');
                
                locations.forEach(loc => {
                    const option1 = new Option(loc.location_name, loc.location_id);
                    const option2 = new Option(loc.location_name, loc.location_id);
                    originSelect.add(option1);
                    destSelect.add(option2);
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Fetch and display rides
        async function loadRides() {
            try {
                const response = await fetch('/api/rides');
                const rides = await response.json();
                
                const container = document.getElementById('rides-container');
                
                if (rides.length === 0) {
                    container.innerHTML = '<p class="empty">No active rides yet. Be the first to post!</p>';
                    return;
                }
                
                container.innerHTML = rides.map(ride => `
                    <div class="ride-card">
                        <div class="ride-header">
                            <span class="badge ${ride.post_type}">${ride.post_type}</span>
                            <span class="name">${escapeHtml(ride.name)}</span>
                        </div>
                        <div class="ride-route">
                            <strong>${ride.origin}</strong> ‚Üí <strong>${ride.destination}</strong>
                        </div>
                        ${ride.post_type === 'offer' && ride.vehicle_model ?
                            `<div class="vehicle-info">
                            üöó <strong>${ride.vehicle_model}</strong>
                            ${ride.available_seats ? ` (${ride.available_seats} seats available)` : ''}
                            </div>` : ''}
                        <div class="ride-schedule">
                            üìÖ ${ride.days_of_week.join(', ')}
                            ${ride.departure_time ? `‚è∞ ${ride.departure_time}` : ''}
                        </div>
                        ${ride.notes ? `<div class="ride-notes">${escapeHtml(ride.notes)}</div>` : ''}
                        <div class="ride-contact"
                             onclick="window.analytics.contactViewed('${ride.contact_method}')">
                            Contact: <strong>${ride.contact_method}</strong> - ${escapeHtml(ride.contact_info)}
                        </div>
                        <div class="ride-meta">
                            Posted ${new Date(ride.created_at).toLocaleDateString()}
                        </div>
                        <div class="ride-actions">
                            <button class="btn-interest" onclick="showInterestModal(${ride.post_id})">
                                üëã I'm Interested
                            </button>
                            <button class="btn-view-interests" onclick="viewInterests(${ride.post_id})">
                                üë• View Interested (<span id="count-${ride.post_id}">${ride.interest_count || 0}</span>)
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading rides:', error);
                document.getElementById('rides-container').innerHTML = 
                    '<p class="error">Failed to load rides. Please refresh the page.</p>';
            }
        }

        // Handle form submission
        document.getElementById('post-ride-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formMessage = document.getElementById('form-message');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Get form data
            const formData = new FormData(e.target);
            const days = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                             .map(cb => cb.value);
            
            if (days.length === 0) {
                formMessage.textContent = 'Please select at least one day';
                formMessage.className = 'form-message error';
                formMessage.setAttribute('role', 'alert');

                // Add inline error near checkbox group
                const checkboxGroup = document.querySelector('.checkbox-group');
                let inlineError = checkboxGroup.parentElement.querySelector('.inline-error');
                if (!inlineError) {
                    inlineError = document.createElement('span');
                    inlineError.className = 'inline-error';
                    inlineError.style.color = '#d73a49';
                    inlineError.style.fontSize = '0.875rem';
                    inlineError.style.marginTop = '0.25rem';
                    inlineError.style.display = 'block';
                    checkboxGroup.parentElement.appendChild(inlineError);
                }
                inlineError.textContent = '‚ö†Ô∏è Please select at least one day';
                inlineError.setAttribute('role', 'alert');
                return;
            }

            // Clear any previous inline errors
            const existingInlineError = document.querySelector('.inline-error');
            if (existingInlineError) {
                existingInlineError.remove();
            }
            
            // Create user first
            const userData = {
                name: formData.get('name'),
                contact_method: formData.get('contact_method'),
                contact_info: formData.get('contact_info')
            };
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Posting...';
                
                // Step 1: Create user
                const userResponse = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                if (!userResponse.ok) throw new Error('Failed to create user');
                const user = await userResponse.json();
                
                // Step 2: Create ride post
                const rideData = {
                    user_id: user.user_id,
                    post_type: formData.get('post_type'),
                    origin_id: parseInt(formData.get('origin')),
                    destination_id: parseInt(formData.get('destination')),
                    days_of_week: days,
                    departure_time: formData.get('departure_time') || null,
                    notes: formData.get('notes') || null,
                    vehicle_model: formData.get('vehicle_model') || null,
                    available_seats: formData.get('available_seats') ? parseInt(formData.get('available_seats')) : null
                };
                
                const rideResponse = await fetch('/api/rides', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rideData)
                });
                
                if (!rideResponse.ok) throw new Error('Failed to create ride');
                
                // Track successful ride post
                window.analytics.ridePosted(formData.get('post_type'));
                // Success!
                formMessage.textContent = '‚úì Ride posted successfully!';
                formMessage.className = 'form-message success';
                e.target.reset();
                
                // Reload rides list
                loadRides();
                
                // Scroll to rides list
                document.getElementById('rides-list').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error posting ride:', error);
                formMessage.textContent = '‚úó Failed to post ride. Please try again.';
                formMessage.className = 'form-message error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post Ride';
            }
        });

        // Make modal keyboard accessible
        function makeModalAccessible(modal) {
            // Get all focusable elements
            const focusableElements = modal.querySelectorAll(
                'button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );

            if (focusableElements.length === 0) return;

            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            // Focus first element
            firstFocusable.focus();

            // Handle keyboard events
            modal.addEventListener('keydown', (e) => {
                // Close on Escape
                if (e.key === 'Escape') {
                    modal.remove();
                    return;
                }

                // Trap focus with Tab
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        // Shift+Tab: if on first element, go to last
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        }
                    } else {
                        // Tab: if on last element, go to first
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                }
            });

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show interest modal
        function showInterestModal(rideId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" role="dialog" aria-labelledby="interest-modal-title">
                    <h2 id="interest-modal-title">Show Interest in This Ride</h2>
                    <div class="privacy-warning" style="background: #fff3cd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border-left: 4px solid #ffc107;">
                        ‚ö†Ô∏è <strong>Privacy Notice:</strong> Your contact information will be visible to anyone viewing this ride.
                    </div>
                    <form id="interest-form">
                        <div class="form-group">
                            <label>Your Name *</label>
                            <input type="text" id="interest-name" required>
                        </div>
                        <div class="form-group">
                            <label>How to contact you *</label>
                            <select id="interest-contact-method" required>
                                <option value="messenger">Messenger</option>
                                <option value="viber">Viber</option>
                                <option value="phone">Phone</option>
                                <option value="telegram">Telegram</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Contact Info *</label>
                            <input type="text" id="interest-contact-info"
                                   placeholder="e.g., facebook.com/yourname or 0917-123-4567" required>
                        </div>
                        <button type="submit" class="btn-submit">Submit Interest</button>
                        <button type="button" class="btn-cancel">Cancel</button>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            makeModalAccessible(modal);

            // Use event delegation on modal to prevent memory leaks
            modal.addEventListener('click', async (e) => {
                if (e.target.closest('.btn-cancel')) {
                    modal.remove();
                } else if (e.target.closest('.btn-submit')) {
                    e.preventDefault();

                    const form = modal.querySelector('#interest-form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const data = {
                        interested_name: document.getElementById('interest-name').value,
                        contact_method: document.getElementById('interest-contact-method').value,
                        contact_info: document.getElementById('interest-contact-info').value
                    };

                    try {
                        const response = await fetch(`/api/rides/${rideId}/interests`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            window.analytics.interestExpressed(rideId);
                            alert('‚úì Interest registered!');
                            modal.remove();
                            loadInterestCount(rideId);
                        } else {
                            const error = await response.json();
                            alert(error.error || 'Failed to register interest');
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        alert('Failed to register interest');
                    }
                }
            });
        }

        // Load interest count
        async function loadInterestCount(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/interests`);
                const interests = await response.json();
                const countEl = document.getElementById(`count-${rideId}`);
                if (countEl) countEl.textContent = interests.length;
            } catch (err) {
                console.error('Error loading interest count:', err);
            }
        }

        // View list of interested people
        async function viewInterests(rideId) {
            try {
                const response = await fetch(`/api/rides/${rideId}/interests`);
                const interests = await response.json();

                // Track view event
                window.analytics.interestsViewed(rideId, interests.length);

                if (interests.length === 0) {
                    alert('No one has shown interest yet.');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" role="dialog" aria-labelledby="view-interests-modal-title">
                        <h2 id="view-interests-modal-title">People Interested in This Ride</h2>
                        <div class="interests-list">
                            ${interests.map(i => `
                                <div class="interest-item">
                                    <strong>${escapeHtml(i.interested_name)}</strong><br>
                                    Contact: ${i.contact_method} - ${escapeHtml(i.contact_info)}<br>
                                    <small>Shown interest ${new Date(i.created_at).toLocaleDateString()}</small>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn-cancel">Close</button>
                    </div>
                `;

                document.body.appendChild(modal);
                makeModalAccessible(modal);

                // Use event delegation on modal to prevent memory leaks
                modal.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-cancel')) {
                        modal.remove();
                    }
                });
            } catch (err) {
                console.error('Error viewing interests:', err);
                alert('Failed to load interested people');
            }
        }

        // Load everything on page load
        loadLocations();
        loadRides();
    </script>
    <%- goatCounterScript %>
</body>
</html>